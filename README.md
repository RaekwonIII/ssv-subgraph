# SSV-Subgraph

This Subgraph is indexing the [SSVNetwork smart contract](https://goerli.etherscan.io/address/0xC3CD9A0aE89Fff83b71b58b6512D43F8a41f363D) through the Events emitted.

## Run local Graph Node

The Subgraph can be deployed on the Graph Network, but for development purposes, a local Graph Node has been utilized. A guide on running a [local Graph Node on Docker can be found here](https://github.com/graphprotocol/graph-node/tree/master/docker)

### Note on M1 chips

- TheGraph's official image is not M1 optimized
    - A “Full” Docker was tested, but didn't work because the node's container kept crashing
- I have tried to build an M1-optimized image, [as detailed here](https://github.com/graphprotocol/graph-node/tree/master/docker#running-graph-node-on-an-macbook-m1), it failed with `error: could not compile graph-node`
- In the end, solution was to run ipfs and postgres in Docker, while compiling and running Graph Node ([as suggested here](https://github.com/graphprotocol/graph-node/issues/2325#issuecomment-944844838))

```bash
cargo run -p graph-node --release -- \
  --postgres-url postgresql://graph-node:let-me-in@localhost:5432/graph-node \
  --ethereum-rpc https://goerli.infura.io/v3/c0c2ce3b9a6f43b4b6dd9f1a7b002fc7 \
  --ipfs 127.0.0.1:5001
```

## Scaffold project

The initial version of the Subgraph was automatically generated by the `init` scaffolding command:

```bash
graph init --allow-simple-name --node http://localhost:8020 \
--from-contract 0xC3CD9A0aE89Fff83b71b58b6512D43F8a41f363D \
--network goerli --abi ~/dev/ssv-network/SSVNetwork.json \
--protocol ethereum --contract-name SSVNetwork --index-events \
--start-block 9203578 ssv-network ssv-subgraph
```

<aside>
⚠️ Make sure to download the contracts ABI [(obtained here](docs.ssv.network/developers/smart-contracts)) and provide the path to it via the `--abi` parameter.

</aside>

## Deploy Subgraph

To deploy the Subgraph to the local node, use the following command:

```bash
graph deploy --node http://localhost:8020 --ipfs http://localhost:5001 ssv-network
```

Wait for the Subgraph to index⏳

## Query indexed data

The Subgraph provides a GraphQL playground at the following URL: [http://localhost:8000/subgraphs/name/ssv-network/](http://localhost:8000/subgraphs/name/ssv-network/)

### Query example

Test your Subgraph by running this query:

```graphql
query MyQuery {
  validatorAddeds(orderBy: blockTimestamp) {
    id
    owner
    publicKey
  }
}
```